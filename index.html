<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aplikasi Ujian Forklift (Teori & Praktek)</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{
  --bg:#f6f7fb; --text:#111827; --card:#fff; --border:#e5e7eb; --muted:#6b7280;
  --primary:#2563eb; --primary-contrast:#fff; --correct:#16a34a; --wrong:#dc2626;
  --shadow:0 2px 10px rgba(0,0,0,.06);
}
body.dark{
  --bg:#0b0f16; --text:#e5e7eb; --card:#111827; --border:#1f2937; --muted:#9ca3af;
  --primary:#60a5fa; --primary-contrast:#0b0f16; --shadow:0 2px 14px rgba(0,0,0,.35);
}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);color:var(--text);transition:.25s;}
header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border);box-shadow:var(--shadow);}
.bar{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.brand{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
nav{display:flex;gap:8px;flex-wrap:wrap;}
.tab{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;}
.tab.active{background:var(--primary);color:var(--primary-contrast);border-color:transparent;}
.icon-btn{background:transparent;border:1px solid var(--border);color:var(--text);
  width:38px;height:38px;border-radius:999px;cursor:pointer;font-size:18px;display:grid;place-items:center;}
.header-info{display:flex;gap:8px;align-items:center;font-weight:600;flex-wrap:wrap;font-size:13px;}
main{max-width:1100px;margin:18px auto;padding:0 16px 24px;}
.status{background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:12px 14px;color:var(--muted);box-shadow:var(--shadow);margin-bottom:14px;font-size:14px;}
.question{background:var(--card);border:1px solid var(--border);border-radius:14px;
  padding:16px;margin-bottom:14px;box-shadow:var(--shadow);}
.q-title{margin:0 0 10px;font-size:16px;line-height:1.35;}
.q-media{max-width:100%;border-radius:10px;margin:10px 0;display:block;}
.options{display:grid;gap:8px;}
.opt{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
  background:var(--card);color:var(--text);text-align:left;cursor:pointer;transition:.2s;font-size:14px;}
.opt.correct{background:var(--correct);color:#fff;border-color:transparent;}
.opt.wrong{background:var(--wrong);color:#fff;border-color:transparent;}
.opt:disabled{opacity:.85;cursor:not-allowed;}
.explain{margin-top:8px;color:var(--correct);font-style:italic;font-size:14px;}
.q-meta{color:#4b5563; font-size:13px; margin-left:4px;}
.footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px;}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);
  background:var(--card);color:var(--text);cursor:pointer;font-weight:600;font-size:14px;}
.btn.primary{background:var(--primary);color:var(--primary-contrast);border-color:transparent;}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:14px;box-shadow:var(--shadow);margin-top:16px;font-size:14px;}
.grid{display:grid;gap:14px;}
/* Responsif grid soal */
.grid.cols-1{grid-template-columns:1fr;}
@media(min-width:480px){.grid.cols-2{grid-template-columns:1fr 1fr;}}
@media(min-width:900px){.grid.cols-3{grid-template-columns:1fr 1fr 1fr;}}
iframe{width:100%;height:220px;border:0;border-radius:10px;}
@media(min-width:480px){iframe{height:260px;}}
@media(min-width:900px){iframe{height:280px;}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <strong>📘 Ujian Forklift</strong>
      <nav>
        <button id="tabTeori" class="tab active" type="button">UJIAN TEORI</button>
        <button id="tabPraktek" class="tab" type="button">UJIAN PRAKTEK</button>
      </nav>
    </div>
    <div class="header-info">
      <div id="answered">Dikerjakan: 0</div>
      <div id="score">Score: 0</div>
      <div id="nilai">Nilai: 0</div>
      <div id="timer">Waktu: 00:00</div>
    </div>
    <button id="toggleDark" class="icon-btn" type="button">🌙</button>
  </div>
</header>

<main>
  <div id="status" class="status">Memuat soal…</div>
  <div id="content"></div>
</main>

<script>
const SHEET_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9M0EUnafqpiKumZMNADPMVF_C6pCHsnBA6FW3UgCbxPIrkC_3elyBRmzR58k9xg/pub?output=csv&sheet=";
const MATERI_SHEET = ["Materi 1","Materi 2","Materi 3","Materi 4","Materi 5","Materi 6"];
const JUMLAH_SOAL = 80;
const MIN_PER_MATERI = 15;

let bankSoalPerMateri = {};
let paketSoal = [];
let jawabanUser = {};
let skor=0, answered=0;
let timerInterval, startTime;

const $=sel=>document.querySelector(sel);
function setStatus(m){const el=$("#status");if(!m){el.style.display="none"}else{el.style.display="block";el.textContent=m}}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function formatTime(sec){const m=String(Math.floor(sec/60)).padStart(2,"0");const s=String(sec%60).padStart(2,"0");return `${m}:${s}`}
function convertDriveLink(u){if(!u) return"";const id=(u.match(/[-\w]{25,}/)||[])[0];return id?`https://drive.google.com/uc?export=view&id=${id}`:u}
function normalizeRow(r){const soal=r["Soal"]||r["soal"]||"";const opsi=[r["A"],r["B"],r["C"],r["D"]].filter(Boolean);
  const gambar=r["Gambar"]?convertDriveLink(r["Gambar"]):"";const kunci=(r["Jawaban"]||"").trim().toUpperCase();const idx="ABCD".indexOf(kunci);
  if(!soal||opsi.length<2||idx<0) return null;return{soal,opsi,kunciIndex:idx,gambar};}

function loadSoal(){
  setStatus("Mengunduh soal dari semua materi…");
  let loaded=0;
  MATERI_SHEET.forEach((sheetName, idx)=>{
    Papa.parse(SHEET_BASE+encodeURIComponent(sheetName),{
      download:true,header:true,skipEmptyLines:true,
      complete:res=>{
        bankSoalPerMateri[sheetName]=res.data.map(normalizeRow).filter(Boolean);
        loaded++;
        if(loaded===MATERI_SHEET.length){
          setStatus("");
          gotoTeori(true);
        }
      },
      error:e=>setStatus("Gagal memuat: "+e.message)
    });
  });
}

function pilihSoal(){
  let hasil=[];
  MATERI_SHEET.forEach((m, idx)=>{
    let arr=bankSoalPerMateri[m]||[];
    if(arr.length>0){
      let selected = shuffle([...arr]).slice(0,MIN_PER_MATERI);
      selected.forEach((q,n)=>{ q.materi = idx+1; q.nomor = n+1; }); // set meta
      hasil.push(...selected);
    }
  });
  let gabungan=[].concat(...Object.values(bankSoalPerMateri));
  gabungan=shuffle(gabungan);
  for(let i=0;i<gabungan.length && hasil.length<JUMLAH_SOAL;i++){
    if(!hasil.includes(gabungan[i])){
      gabungan[i].materi=0; gabungan[i].nomor=0;
      hasil.push(gabungan[i]);
    }
  }
  return shuffle(hasil).slice(0, JUMLAH_SOAL);
}

function startTimer(){if(timerInterval) return;startTime=Date.now();
  timerInterval=setInterval(()=>{const diff=Math.floor((Date.now()-startTime)/1000);
    $("#timer").textContent="Waktu: "+formatTime(diff);},1000);}
function updateHeader(){$("#answered").textContent="Dikerjakan: "+answered;
  $("#score").textContent="Score: "+skor;
  $("#nilai").textContent="Nilai: "+(skor*1.25).toFixed(2);}

function gotoTeori(reset=false){
  $("#tabTeori").classList.add("active");$("#tabPraktek").classList.remove("active");$("#content").innerHTML="";
  if(reset){paketSoal=pilihSoal();jawabanUser={};skor=0;answered=0;clearInterval(timerInterval);timerInterval=null;
    $("#timer").textContent="Waktu: 00:00";updateHeader();}
  renderTeori();
}

function renderTeori(){
  const root=$("#content");
  paketSoal.forEach((q,i)=>{
    const card=document.createElement("div");card.className="question";
    const metaText = `(Materi ${q.materi || '?'} - Soal ${q.nomor || (i+1)})`;
    card.innerHTML=`<h3 class="q-title">${i+1}. ${q.soal} <span class="q-meta">${metaText}</span></h3>`;
    if(q.gambar) card.innerHTML+=`<img class="q-media" src="${q.gambar}">`;
    const opts=document.createElement("div");opts.className="options";
    q.opsi.forEach((opt,j)=>{
      const huruf=String.fromCharCode(65+j);
      const btn=document.createElement("button");btn.className="opt";btn.type="button";btn.textContent=`${huruf}. ${opt}`;
      btn.onclick=()=>{
        if(jawabanUser[i]) return;
        jawabanUser[i]=huruf;answered++;if(answered===1) startTimer();
        const benar=q.kunciIndex;
        if(j===benar){btn.classList.add("correct");skor++;}else{
          btn.classList.add("wrong");opts.children[benar].classList.add("correct");
          const exp=document.createElement("div");exp.className="explain";
          exp.textContent=`Jawaban benar: ${String.fromCharCode(65+benar)}. ${q.opsi[benar]}`;
          card.appendChild(exp);
        }
        [...opts.children].forEach(b=>b.disabled=true);updateHeader();
      };
      opts.appendChild(btn);
    });
    card.appendChild(opts);root.appendChild(card);
  });
  const actions=document.createElement("div");actions.className="footer-actions";
  actions.innerHTML=`<button class="btn" id="btnUlangi">Acak Ulang Soal</button>
    <button class="btn primary" id="btnSelesai">Selesai & Rangkuman</button>`;
  root.appendChild(actions);
  $("#btnUlangi").onclick=()=>gotoTeori(true);$("#btnSelesai").onclick=rangkuman;
}

function rangkuman(){
  const salah=[];paketSoal.forEach((q,i)=>{const benar=String.fromCharCode(65+q.kunciIndex);
    if(jawabanUser[i]!==benar){salah.push({no:i+1,benar:`${benar}. ${q.opsi[q.kunciIndex]}`});}});
  const box=document.createElement("div");box.className="card";
  box.innerHTML=`<h3>Hasil Ujian</h3>
    <p><b>Score:</b> ${skor}</p><p><b>Nilai:</b> ${(skor*1.25).toFixed(2)}</p>
    <p><b>Waktu:</b> ${$("#timer").textContent.replace("Waktu: ","")}</p>
    ${salah.length?`<p><b>Soal yang salah:</b></p><ul>${salah.map(s=>`<li>No ${s.no} → ${s.benar}</li>`).join("")}</ul>`:"<p>🎉 Semua benar!</p>"}`;
  $("#content").appendChild(box);
}

function gotoPraktek(){
  $("#tabTeori").classList.remove("active");$("#tabPraktek").classList.add("active");
  $("#content").innerHTML=`<div class="grid cols-2">
    <div class="card"><h3>Video Praktek Sesi 1</h3><iframe src="https://www.youtube.com/embed/pTxyWrFCz6w"></iframe></div>
    <div class="card"><h3>Video Praktek Sesi 2</h3><iframe src="https://www.youtube.com/embed/CDz1AMt14Us"></iframe></div>
    <div class="card"><h3>Video Praktek Sesi 3</h3><iframe src="https://www.youtube.com/embed/PwxCufCy9Ss"></iframe></div>
    <div class="card"><h3>Materi Ujian Praktek</h3><a href="https://drive.google.com/file/d/1JQ4MXpNOZwBGqU0lR3hDYkS5b567iu2y/view" target="_blank">📄 Buka Materi</a></div>
  </div>`;
}

$("#toggleDark").onclick=()=>{document.body.classList.toggle("dark");
  $("#toggleDark").textContent=document.body.classList.contains("dark")?"☀️":"🌙";}
$("#tabTeori").onclick=()=>gotoTeori(false);$("#tabPraktek").onclick=gotoPraktek;

loadSoal();
</script>
</body>
</html>
