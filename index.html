<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aplikasi Ujian Forklift (Teori & Praktek)</title>
<link rel="icon" href="https://iili.io/KoCVI7j.png" type="image/png">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{
  --bg:#f6f7fb; --text:#111827; --card:#fff; --border:#e5e7eb; --muted:#6b7280;
  --primary:#2563eb; --primary-contrast:#fff; --correct:#16a34a; --wrong:#dc2626;
  --shadow:0 2px 10px rgba(0,0,0,.06);
}
body.dark{
  --bg:#0b0f16; --text:#e5e7eb; --card:#111827; --border:#1f2937; --muted:#9ca3af;
  --primary:#60a5fa; --primary-contrast:#0b0f16; --shadow:0 2px 14px rgba(0,0,0,.35);
}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);color:var(--text);transition:.25s;}
header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border);box-shadow:var(--shadow);}
.bar{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.brand{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
nav{display:flex;gap:8px;flex-wrap:wrap;}
.tab{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;}
.tab.active{background:var(--primary);color:var(--primary-contrast);border-color:transparent;}
.icon-btn{background:transparent;border:1px solid var(--border);color:var(--text);
  width:38px;height:38px;border-radius:999px;cursor:pointer;font-size:18px;display:grid;place-items:center;}
.header-info{display:flex;gap:8px;align-items:center;font-weight:600;flex-wrap:wrap;font-size:13px;}
main{max-width:1100px;margin:18px auto;padding:0 16px 24px;}
.status{background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:12px 14px;color:var(--muted);box-shadow:var(--shadow);margin-bottom:14px;font-size:14px;}
.question{background:var(--card);border:1px solid var(--border);border-radius:14px;
  padding:16px;margin-bottom:14px;box-shadow:var(--shadow);}
.q-title{margin:0 0 10px;font-size:16px;line-height:1.35;}
.q-media{max-width:100%;border-radius:10px;margin:10px 0;display:block;}
.options{display:grid;gap:8px;}
.opt{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
  background:var(--card);color:var(--text);text-align:left;cursor:pointer;transition:.2s;font-size:14px;}
.opt.correct{background:var(--correct);color:#fff;border-color:transparent;}
.opt.wrong{background:var(--wrong);color:#fff;border-color:transparent;}
.opt:disabled{opacity:.85;cursor:not-allowed;}
.explain{margin-top:8px;color:var(--correct);font-style:italic;font-size:14px;}
.q-meta{color:#4b5563; font-size:13px; margin-left:4px;}
.footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px;}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);
  background:var(--card);color:var(--text);cursor:pointer;font-weight:600;font-size:14px;}
.btn.primary{background:var(--primary);color:var(--primary-contrast);border-color:transparent;}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:14px;box-shadow:var(--shadow);margin-top:16px;font-size:14px;}
.grid{display:grid;gap:14px;}
.grid.cols-1{grid-template-columns:1fr;}
@media(min-width:480px){.grid.cols-2{grid-template-columns:1fr 1fr;}}
@media(min-width:900px){.grid.cols-3{grid-template-columns:1fr 1fr 1fr;}}
iframe{width:100%;height:220px;border:0;border-radius:10px;}
@media(min-width:480px){iframe{height:260px;}}
@media(min-width:900px){iframe{height:280px;}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <strong>📘 Ujian Forklift</strong>
      <nav>
        <button id="tabTeori" class="tab active" type="button">UJIAN TEORI</button>
        <button id="tabPraktek" class="tab" type="button">UJIAN PRAKTEK</button>
      </nav>
    </div>
    <div class="header-info">
      <div id="answered">Dikerjakan: 0</div>
      <div id="score">Score: 0</div>
      <div id="nilai">Nilai: 0</div>
      <div id="timer">Waktu: 00:00</div>
    </div>
    <button id="toggleDark" class="icon-btn" type="button">🌙</button>
  </div>
</header>

<main>
  <div id="status" class="status">Memuat soal…</div>
  <div id="content"></div>
</main>

<script>
// ===== Helper =====
const $ = (sel) => document.querySelector(sel);

function convertDriveLink(url){
  if(!url) return "";
  const m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
  return url;
}
function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i],array[j]] = [array[j],array[i]];
  }
  return array;
}
function formatTime(seconds){
  const m = String(Math.floor(seconds/60)).padStart(2,'0');
  const s = String(seconds%60).padStart(2,'0');
  return `${m}:${s}`;
}

// ===== Variabel global =====
let bankSoalPerMateri = {};
let paketSoal = [];
let jawabanUser = {};
let skor = 0;
let answered = 0;
let timerInterval = null;
let startTime = null;
const JUMLAH_SOAL = 80;

// ===== Track soal keluar per materi antar sesi =====
const keluarPerMateri = {};

// ===== URL CSV Google Sheets =====
const SHEET_URLS = {
  "Materi 15100-01": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9M0EUnafqpiKumZMNADPMVF_C6pCHsnBA6FW3UgCbxPIrkC_3elyBRmzR58k9xg/pub?gid=1474425519&single=true&output=csv",
  "Materi 15100-02": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS57tCXmhF0jTGIMFaEG0He34m8cht6MEVhVEnnRzCvaUKPmmmLdwrxlLHNT23cOGQZbqXSN5K9m_J2/pub?gid=0&single=true&output=csv",
  "Materi 15100-03": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJwU-2UAEtPEQ6WHzKAP8xxfUyVk5UIm2U9ezt8x16EK6RyXeE3w8ueRXM5Gw88OLj_t0Sm6sPq6UK/pub?gid=0&single=true&output=csv",
  "Materi 90006-01": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8inB0ricy7-j0JGfYg8He8OXVYBd2HoxHjPbwYcRYrOGEyOg5YtdNJjDQFZD52jwpFP8yvZnqZUuZ/pub?gid=0&single=true&output=csv",
  "Materi 90007-01": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5EbPvY2KjT_BhThOu6cBX7lb34nGI9YWJV-Vnm7I048vWrRhJekvvPTeDQXBPT3jLFjHXYRRiLlHr/pub?gid=0&single=true&output=csv",
  "Materi 90008-03": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKtRiS6FWwAnquLFXSOqTlazfN0fr-mS-F884PZHBauZDk2rcGl8J40Ix7f69TTAxUURen6I0wJgSQ/pub?gid=0&single=true&output=csv",
  "Materi 90009-04": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcnFzhmKlcwbQB0Lyznkf4gaCwbSMH5X8O5TIKtwlf1OFgoG3iLRsuGZvTefqLESWJF5A9Y6qOhEoe/pub?gid=0&single=true&output=csv"
};

// ===== Normalisasi soal =====
function normalizeRow(r, materi){
  const soal = r["Soal"] || "";
  const gambar = r["Gambar"] ? convertDriveLink(r["Gambar"]) : "";
  const kunci = (r["Jawaban"] || "").trim().toUpperCase();
  const idx = "ABCD".indexOf(kunci);
  const noSoal = r["No"] || r["Nomor"] || "";
  if(!soal || idx<0) return null;

  const opsi = ["A","B","C","D"].map(h=>{
    let val = r[h]? r[h].trim() : "";
    if(!val) return null;
    if(val.match(/\.(jpg|jpeg|png|gif)$/i) || val.includes("drive.google.com")){
      return {type:"img", value: convertDriveLink(val)};
    } else {
      return {type:"text", value: val};
    }
  }).filter(Boolean);

  if(opsi.length<2) return null;
  return {soal, opsi, kunciIndex: idx, gambar, materi, noSoal};
}

// ===== Load soal (Promise.all) =====
function setStatus(t){$("#status").textContent=t;}

function loadCSV(url, materi){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,
      complete:res=>{
        const soalValid=res.data.map((row,i)=>{
          const q=normalizeRow(row,materi);
          if(q) q.sheetNo=i+2;
          return q;
        }).filter(Boolean);
        resolve({materi,soal:soalValid});
      },
      error:e=>reject(e)
    });
  });
}

async function loadSoal(){
  try{
    setStatus("Mengunduh semua soal…");
    const entries=Object.entries(SHEET_URLS).filter(([_,url])=>url);
    const hasil=await Promise.all(entries.map(([materi,url])=>loadCSV(url,materi)));
    hasil.forEach(({materi,soal})=>{bankSoalPerMateri[materi]=soal;});
    setStatus(""); gotoTeori(true);
  }catch(e){console.error(e); setStatus("Gagal memuat soal.");}
}

// ===== Jumlah soal per materi =====
const JUMLAH_PER_MATERI = {
  "Materi 15100-01": 18,
  "Materi 15100-02": 17,
  "Materi 15100-03": 17,
  "Materi 90006-01": 7,
  "Materi 90007-01": 7,
  "Materi 90008-03": 7,
  "Materi 90009-04": 7
};

// ===== Pilih soal tanpa mengulang antar sesi =====
function pilihSoal(){
  let hasil = [];

  Object.keys(JUMLAH_PER_MATERI).forEach(materi=>{
    let arr = bankSoalPerMateri[materi] || [];
    if(arr.length===0) return;

    if(!keluarPerMateri[materi]) keluarPerMateri[materi] = new Set();
    let needed = JUMLAH_PER_MATERI[materi];

    // soal yang belum keluar
    let remaining = arr.filter(q=>{
      let key = q.soal + "||" + JSON.stringify(q.opsi) + "||" + q.kunciIndex;
      return !keluarPerMateri[materi].has(key);
    });

    let takeNow = Math.min(needed, remaining.length);
    let selected = shuffle([...remaining]).slice(0, takeNow);

    selected.forEach(q=>{
      let key = q.soal + "||" + JSON.stringify(q.opsi) + "||" + q.kunciIndex;
      hasil.push(q);
      keluarPerMateri[materi].add(key);
    });

    // jika masih kurang, ambil dari materi yang sama (semua soal sudah keluar)
    if(selected.length < needed){
      let toPick = needed - selected.length;
      let shuffled = shuffle([...arr]);
      for(let q of shuffled){
        let key = q.soal + "||" + JSON.stringify(q.opsi) + "||" + q.kunciIndex;
        if(!hasil.includes(q)){ // pastikan tidak duplikat di sesi ini
          hasil.push(q);
          toPick--;
          if(toPick <= 0) break;
        }
      }
    }
  });

  return shuffle(hasil).slice(0, JUMLAH_SOAL);
}

// ===== Timer & Header =====
function startTimer(){if(timerInterval) return; startTime=Date.now();
  timerInterval=setInterval(()=>{$("#timer").textContent="Waktu: "+formatTime(Math.floor((Date.now()-startTime)/1000));},1000);}

function updateHeader(){
  $("#answered").textContent="Dikerjakan: "+answered;
  $("#score").textContent="Score: "+skor;
  $("#nilai").textContent="Nilai: "+(skor*1.25).toFixed(2);
}

// ===== Render Teori =====
function gotoTeori(reset=false){
  $("#tabTeori").classList.add("active"); $("#tabPraktek").classList.remove("active");
  $("#content").innerHTML="";
  if(reset){
    paketSoal=pilihSoal(); 
    jawabanUser={}; skor=0; answered=0; 
    clearInterval(timerInterval); timerInterval=null; 
    $("#timer").textContent="Waktu: 00:00"; 
    updateHeader();
  }
  renderTeori();
}

function renderTeori(){
  const root=$("#content");
  paketSoal.forEach((q,i)=>{
    const card=document.createElement("div"); card.className="question";
    const metaText=`(${q.materi} - Soal ${q.noSoal})`;
    card.innerHTML=`<h3 class="q-title">${i+1}. ${q.soal} <span class="q-meta">${metaText}</span></h3>`;
    if(q.gambar) card.innerHTML+=`<img class="q-media" src="${q.gambar}">`;
    const opts=document.createElement("div"); opts.className="options";
    q.opsi.forEach((opt,j)=>{
      const huruf=String.fromCharCode(65+j);
      const btn=document.createElement("button"); btn.className="opt"; btn.type="button";
      btn.innerHTML=opt.type==="img"? `<strong>${huruf}.</strong><br><img src="${opt.value}" style="max-width:120px;max-height:120px;">`:`${huruf}. ${opt.value}`;
      btn.onclick=()=>{if(jawabanUser[i]) return; jawabanUser[i]=huruf; answered++; if(answered===1) startTimer();
        const benar=q.kunciIndex; if(j===benar){btn.classList.add("correct"); skor++;}else{btn.classList.add("wrong"); opts.children[benar].classList.add("correct");}
        [...opts.children].forEach(b=>b.disabled=true); updateHeader();};
      opts.appendChild(btn);
    });
    card.appendChild(opts); root.appendChild(card);
  });
  const actions=document.createElement("div"); actions.className="footer-actions";
  actions.innerHTML=`<button class="btn" id="btnUlangi">Acak Ulang Soal</button><button class="btn primary" id="btnSelesai">Selesai & Rangkuman</button>`;
  root.appendChild(actions);
  $("#btnUlangi").onclick=()=>gotoTeori(true); $("#btnSelesai").onclick=rangkuman;
}

// ===== Rangkuman =====
function rangkuman(){
  if(timerInterval) clearInterval(timerInterval);
  let salah = [];
  paketSoal.forEach((q,i)=>{
    const jawaban = jawabanUser[i];
    if(!jawaban || "ABCD"[q.kunciIndex] !== jawaban){
      salah.push(i+1);
    }
  });
  const box = document.createElement("div");
  box.className = "card";
  box.innerHTML = `
    <h3>Hasil Ujian</h3>
    <p><b>Score:</b> ${skor}</p>
    <p><b>Nilai:</b> ${(skor*1.25).toFixed(2)}</p>
    <p><b>Waktu:</b> ${$("#timer").textContent.replace("Waktu: ","")}</p>
    <p><b>Soal Salah:</b> ${salah.length ? salah.join(", ") : "Tidak ada"}</p>
  `;
  $("#content").appendChild(box);
}

// ===== Praktek =====
function gotoPraktek(){
  $("#tabTeori").classList.remove("active"); $("#tabPraktek").classList.add("active");
  $("#content").innerHTML=`<div class="grid cols-2">
    <div class="card"><h3>Video Praktek 1</h3><iframe src="https://www.youtube.com/embed/pTxyWrFCz6w"></iframe></div>
    <div class="card"><h3>Video Praktek 2</h3><iframe src="https://www.youtube.com/embed/CDz1AMt14Us"></iframe></div>
    <div class="card"><h3>Video Praktek Sesi 3</h3><iframe src="https://www.youtube.com/embed/PwxCufCy9Ss"></iframe></div>
    <div class="card"><h3>Materi Ujian Praktek</h3><a href="https://drive.google.com/file/d/1JQ4MXpNOZwBGqU0lR3hDYkS5b567iu2y/view" target="_blank">📄 Buka Materi</a></div>
  </div>`;
}

// ===== Event =====
$("#toggleDark").onclick=()=>{document.body.classList.toggle("dark"); $("#toggleDark").textContent=document.body.classList.contains("dark")?"☀️":"🌙";};
$("#tabTeori").onclick=()=>gotoTeori(false);
$("#tabPraktek").onclick=gotoPraktek;

// ===== Load soal =====
loadSoal();
</script>
</body>
</html>
